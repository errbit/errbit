language: ruby

rvm:
  - 2.3
  - 2.4

env:
  global:
    - COVERAGE=true JRUBY_OPTS=--debug
  matrix:
    - MONGODB=2.6.10
    - MONGODB=3.6.1

sudo: false

cache: bundler

install:
  - wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-${MONGODB}.tgz
  - tar xzf mongodb-linux-x86_64-${MONGODB}.tgz
  - ${PWD}/mongodb-linux-x86_64-${MONGODB}/bin/mongod --version

before_script:
  - mkdir ${PWD}/mongodb-linux-x86_64-${MONGODB}/data
  - >
    ${PWD}/mongodb-linux-x86_64-${MONGODB}/bin/mongod
    --dbpath ${PWD}/mongodb-linux-x86_64-${MONGODB}/data
    --logpath ${PWD}/mongodb-linux-x86_64-${MONGODB}/mongodb.log
    --auth --fork
  - until nc -z localhost 27017; do echo "waiting for mongodb ${MONGODB}"; sleep 1; done
  - bundle install
  - bundle exec rake errbit:bootstrap

script:
  - bundle exec rspec
  - bundle exec rubocop
